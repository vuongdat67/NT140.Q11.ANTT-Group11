name: Generate API Documentation

on:
  push:
    branches:
      - master
    paths:
      - 'include/**'
      - 'src/**'
      - 'docs/**'
      - 'Doxyfile'
      - 'README.md'
      - '.github/workflows/doxygen.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-docs:
    name: Build Doxygen Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz texlive-latex-base texlive-latex-extra texlive-fonts-recommended
      
      - name: Enable LaTeX generation in Doxyfile
        run: |
          # Temporarily enable LaTeX generation for workflow
          sed -i 's/GENERATE_LATEX         = NO/GENERATE_LATEX         = YES/' Doxyfile
          echo "âœ“ LaTeX generation enabled"
      
      - name: Generate Doxygen documentation
        run: |
          doxygen Doxyfile
      
      - name: Strip emojis from LaTeX files
        run: |
          if [ -d docs/doxygen/latex ]; then
            # Remove emoji patterns from all .tex files
            find docs/doxygen/latex -name "*.tex" -type f -exec sed -i 's/[ðŸ˜€-ðŸ™ðŸŒ€-ðŸ—¿ðŸš€-ðŸ›¿âœ€-âž¿]/[emoji]/g' {} + || true
            
            # Also remove specific unicode emoji ranges
            find docs/doxygen/latex -name "*.tex" -type f -exec sed -i 's/[\xF0\x9F][\x80-\xBF][\x80-\xBF][\x80-\xBF]//g' {} + || true
            
            # Remove zero-width characters and other problematic unicode
            find docs/doxygen/latex -name "*.tex" -type f -exec sed -i 's/[\u200B-\u200D\uFEFF]//g' {} + || true
            
            echo "âœ“ Emojis stripped from LaTeX files"
          fi
      
      - name: Build LaTeX PDF
        continue-on-error: true
        run: |
          if [ -d docs/doxygen/latex ]; then
            cd docs/doxygen/latex
            make pdf 2>&1 | tee build.log || echo "âš  LaTeX PDF build had errors (non-critical)"
            
            if [ -f refman.pdf ]; then
              echo "âœ… PDF successfully generated: refman.pdf"
            else
              echo "âŒ PDF generation failed, see build.log"
            fi
          fi
      
      - name: Checkout API branch
        run: |
          # Save current commit SHA
          MASTER_SHA=$(git rev-parse --short HEAD)
          echo "MASTER_SHA=$MASTER_SHA" >> $GITHUB_ENV
          
          # Fetch and checkout API branch
          git fetch origin API || true
          git checkout API || git checkout -b API
          
          # Clear existing docs
          rm -rf doxygen
          git rm -rf doxygen 2>/dev/null || true
          
          echo "âœ“ Checked out API branch"
      
      - name: Copy documentation to API branch
        run: |
          # Copy generated HTML documentation
          mkdir -p doxygen
          cp -r docs/doxygen/html doxygen/
          
          # Copy LaTeX documentation if exists
          if [ -d docs/doxygen/latex ]; then
            cp -r docs/doxygen/latex doxygen/
            
            # Keep only the PDF if it was built successfully
            if [ -f doxygen/latex/refman.pdf ]; then
              mkdir -p doxygen/pdf
              cp doxygen/latex/refman.pdf doxygen/pdf/FileVault-API.pdf
              echo "âœ… PDF copied to doxygen/pdf/FileVault-API.pdf"
            fi
          fi
          
          echo "âœ“ Documentation copied to API branch"
          
          # Create README for API branch
          echo "# FileVault API Documentation" > doxygen/README.md
          echo "" >> doxygen/README.md
          echo "Auto-generated API documentation using Doxygen." >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "## Contents" >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "- **html/** - HTML documentation" >> doxygen/README.md
          echo "- **latex/** - LaTeX source files" >> doxygen/README.md
          echo "- **pdf/** - PDF documentation (if built)" >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "## View Online" >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "Open html/index.html in your browser." >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "Generated from commit: $MASTER_SHA" >> doxygen/README.md
          
          echo "âœ“ README created for API branch"
      
      - name: Commit and push to API branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add doxygen/
          
          # Commit with detailed message
          git commit -m "docs: Update API documentation

          Auto-generated from commit $(git rev-parse --short HEAD)
          
          Changes:
          - HTML documentation
          - LaTeX sources (emoji-stripped)
          - PDF documentation (if built)
          
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          
          git push origin API --force
          
          echo "âœ“ Documentation pushed to API branch"
      
      - name: Create deployment info
        run: |
          echo "## ðŸ“š Documentation Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Documentation successfully generated and deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‚ Output" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`API\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Size**: $(du -sh doxygen/html | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access" >> $GITHUB_STEP_SUMMARY
          echo "Clone the API branch to view documentation:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git clone -b API https://github.com/${{ github.repository }}.git filevault-docs" >> $GITHUB_STEP_SUMMARY
          echo "cd filevault-docs/doxygen/html" >> $GITHUB_STEP_SUMMARY
          echo "# Open index.html in browser" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
